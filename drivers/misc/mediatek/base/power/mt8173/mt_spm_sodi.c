/*
 * Copyright (C) 2015 MediaTek Inc.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License version 2 as
 * published by the Free Software Foundation.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 */

#include <linux/delay.h>
#include <linux/init.h>
#include <linux/irqchip/mt-gic.h>
#include <linux/kernel.h>
#include <linux/lockdep.h>
#include <linux/module.h>
#include <linux/spinlock.h>
#include <mt-plat/mt_cirq.h>

#include "mt_cpufreq.h"
#include "mt_cpuidle.h"
#include "mt_spm_idle.h"
#include "mt_spm_internal.h"

#ifdef CONFIG_OF
#include <linux/of.h>
#include <linux/of_irq.h>
#include <linux/of_address.h>
#endif

/**************************************
 * only for internal debug
 **************************************/
/* FIXME: for FPGA early porting */
#ifndef CONFIG_MTK_LDVT
#define  CONFIG_MTK_LDVT
#endif

#define SODI_DVT_APxGPT 0	/* 0:disable, 1: enable : use in android load: mt_idle.c and mt_spm_sodi.c */
#define SODI_DVT_BLOCK_BF_WFI 0	/* blcok code before while issue WFI for step by step current measurement */
#define SODI_DVT_SPM_DBG_MODE 0	/* 1: using debug mode fw, 0: normal fw */
#define SODI_DVT_SPM_MEM_RW_TEST 0
#define SODI_DVT_MAGIC_NUM 0xa5a5a5a5

#if SODI_DVT_SPM_MEM_RW_TEST
static u32 magicArray[16] = {
	SODI_DVT_MAGIC_NUM, SODI_DVT_MAGIC_NUM, SODI_DVT_MAGIC_NUM, SODI_DVT_MAGIC_NUM,
	SODI_DVT_MAGIC_NUM, SODI_DVT_MAGIC_NUM, SODI_DVT_MAGIC_NUM, SODI_DVT_MAGIC_NUM,
	SODI_DVT_MAGIC_NUM, SODI_DVT_MAGIC_NUM, SODI_DVT_MAGIC_NUM, SODI_DVT_MAGIC_NUM,
	SODI_DVT_MAGIC_NUM, SODI_DVT_MAGIC_NUM, SODI_DVT_MAGIC_NUM, SODI_DVT_MAGIC_NUM,
};
#endif

#ifdef CONFIG_MTK_LDVT
#define SPM_BYPASS_SYSPWREQ     1
#else
#define SPM_BYPASS_SYSPWREQ     0
#endif

#if SODI_DVT_APxGPT		/* APxGPT test only */
#if SODI_DVT_BLOCK_BF_WFI
#define WAKE_SRC_FOR_SODI \
	(WAKE_SRC_EINT)
#else
#define WAKE_SRC_FOR_SODI \
	(WAKE_SRC_GPT)
#endif

#else
#define WAKE_SRC_FOR_SODI \
	(WAKE_SRC_KP | WAKE_SRC_GPT | WAKE_SRC_EINT |        \
	WAKE_SRC_MD32 | WAKE_SRC_USB_CD | WAKE_SRC_USB_PDN |  \
	WAKE_SRC_AFE | WAKE_SRC_CIRQ | WAKE_SRC_SYSPWREQ |         \
	WAKE_SRC_CPU_IRQ)
#endif

#define WAKE_SRC_FOR_MD32  0                                          \
				/* (WAKE_SRC_AUD_MD32) */

#ifdef CONFIG_OF
static void __iomem *mcucfg_base;
#define MCUSYS_CONFIG          (mcucfg_base + 0x600)	/* 10200600 */
#endif

/* ========================================== */
/* PCM code for SODI (Screen On Deep Idle) */
/*  */
/* core 0 : GPT 4 */
/* ========================================== */
#if SODI_DVT_SPM_DBG_MODE
static const u32 sodi_binary[] = {
	0x81411801, 0xd8000165, 0x17c07c1f, 0x18c0001f, 0x10006240, 0xe0e00016,
	0xe0e0001e, 0xe0e0000e, 0xe0e0000f, 0xc28015a0, 0x17c07c1f, 0x80368400,
	0x1b80001f, 0x20000208, 0x80370400, 0x1b80001f, 0x20000208, 0x80360400,
	0x803e0400, 0x1b80001f, 0x20000208, 0x80380400, 0x803b0400, 0xa01d8400,
	0x1b80001f, 0x20000034, 0x803d8400, 0x1b80001f, 0x20000152, 0x803d0400,
	0x1b80001f, 0x20000208, 0x18c0001f, 0x1000f5c8, 0x1910001f, 0x1000f5c8,
	0xa1000404, 0xe0c00004, 0x18c0001f, 0x100125c8, 0x1910001f, 0x100125c8,
	0xa1000404, 0xe0c00004, 0x1910001f, 0x100125c8, 0x80340400, 0x17c07c1f,
	0x17c07c1f, 0x80310400, 0x1b80001f, 0x2000000a, 0x18c0001f, 0x10006240,
	0xe0e0000d, 0xd8000725, 0x17c07c1f, 0x1b80001f, 0x20000100, 0x81fa0407,
	0x81f08407, 0x81f18407, 0xe8208000, 0x10006354, 0xfffe7b01, 0xa1d80407,
	0xa1dc0407, 0x8880000c, 0x2f7be35f, 0xd8200962, 0x17c07c1f, 0x1b00001f,
	0x3fffe7ff, 0xd00009a0, 0x17c07c1f, 0x1b00001f, 0xbfffe7ff, 0xf0000000,
	0x17c07c1f, 0x1b80001f, 0x20000fdf, 0x1890001f, 0x10006608, 0x80c98801,
	0x810a8801, 0x10918c1f, 0xa0939002, 0xa0950402, 0x8080080d, 0xd8200ca2,
	0x17c07c1f, 0x1b00001f, 0x3fffe7ff, 0x1b80001f, 0x20000004, 0xd800156c,
	0x17c07c1f, 0x1b00001f, 0xbfffe7ff, 0xd0001560, 0x17c07c1f, 0x81f80407,
	0x81fc0407, 0xe8208000, 0x10006354, 0xffffffff, 0x1b80001f, 0x20000020,
	0x02000408, 0x1880001f, 0x10006320, 0xc0c026a0, 0xe080000f, 0xd8000c23,
	0x17c07c1f, 0xe080001f, 0x1950001f, 0x10006b00, 0x81429401, 0xd8000e85,
	0x17c07c1f, 0xa1da0407, 0xa0110400, 0xa0140400, 0x18c0001f, 0x1000f5c8,
	0x1910001f, 0x1000f5c8, 0x81200404, 0xe0c00004, 0x18c0001f, 0x100125c8,
	0x1910001f, 0x100125c8, 0x81200404, 0xe0c00004, 0x1910001f, 0x100125c8,
	0xa01d0400, 0xa01b0400, 0xa0180400, 0x1950001f, 0x10006b00, 0x81431401,
	0xd80011a5, 0x17c07c1f, 0xa01e0400, 0xa0160400, 0xa0170400, 0xa0168400,
	0x1b80001f, 0x20000104, 0x1950001f, 0x10006b00, 0x81439401, 0xd8001305,
	0x17c07c1f, 0x81411801, 0xd8001485, 0x17c07c1f, 0x18c0001f, 0x10006240,
	0xc0c025e0, 0x17c07c1f, 0x1950001f, 0x10006b00, 0x81441401, 0xd8001485,
	0x17c07c1f, 0x1b00001f, 0x7fffe7ff, 0xf0000000, 0x17c07c1f, 0x18c0001f,
	0x100110e4, 0x1910001f, 0x100110e4, 0xa1158404, 0xe0c00004, 0x81358404,
	0xe0c00004, 0x18c0001f, 0x100040e4, 0x1910001f, 0x100040e4, 0xa1158404,
	0xe0c00004, 0x81358404, 0xe0c00004, 0xf0000000, 0x17c07c1f, 0x803d8400,
	0x1b80001f, 0x2000001a, 0x80340400, 0x17c07c1f, 0x17c07c1f, 0x80310400,
	0x89c00007, 0xffeffff5, 0xa9c00007, 0x01010000, 0xe8208000, 0x10006354,
	0xfffe7b01, 0x1b80001f, 0x200000d0, 0x1b00001f, 0xbfffe7ff, 0x1b00001f,
	0xffffffff, 0x1b80001f, 0x20000004, 0x8a80000c, 0x2f7be35f, 0xd8201b6a,
	0x17c07c1f, 0x1b00001f, 0x3fffe7ff, 0xf0000000, 0x17c07c1f, 0x1a90001f,
	0x10212018, 0x828fa801, 0xa281b40a, 0xa285340a, 0x82802801, 0xd80019ea,
	0x17c07c1f, 0x1b00001f, 0xffffffff, 0x1b80001f, 0x20000004, 0x8a80000c,
	0x2f7be35f, 0xd8001b2a, 0x17c07c1f, 0xe8208000, 0x10006354, 0xffffffff,
	0x1b80001f, 0x20000020, 0x02000408, 0x89c00007, 0xfefeffff, 0xa9c00007,
	0x0010000a, 0x1b80001f, 0x20000020, 0x810ab401, 0x80cbb401, 0x80c00c04,
	0xd80022e3, 0x17c07c1f, 0x89c00007, 0xfffffff5, 0xa9c00007, 0x0000000a,
	0x1b80001f, 0x20000020, 0x810ab401, 0x80cbb401, 0x80c00c04, 0xd80022e3,
	0x17c07c1f, 0x89c00007, 0xffeffff5, 0xa9c00007, 0x01010000, 0x1880001f,
	0x10006814, 0xe0800001, 0x1880001f, 0x10006320, 0xe080000f, 0x1b00001f,
	0x2f7be35f, 0xd00025a0, 0x17c07c1f, 0x1950001f, 0x10006b00, 0x81449401,
	0xd80022e5, 0x17c07c1f, 0x1940001f, 0x001c0bae, 0xa0110400, 0xa0140400,
	0x814f9801, 0xd8002485, 0x17c07c1f, 0xa01d8400, 0x1b00001f, 0x7fffe7ff,
	0x1950001f, 0x10006b00, 0x81451401, 0xd80024c5, 0x17c07c1f, 0x1940001f,
	0x001c0bae, 0xf0000000, 0x17c07c1f, 0xe0f07f0d, 0xe0f07f0f, 0xe0f07f1e,
	0xe0f07f12, 0xf0000000, 0x17c07c1f, 0x11407c1f, 0x81f08407, 0x81f18407,
	0x1b80001f, 0x20000001, 0xa1d08407, 0xa1d18407, 0x1b80001f, 0x20000020,
	0x812ab401, 0x80ebb401, 0xa0c00c04, 0xd82028c3, 0x17c07c1f, 0x80c01403,
	0xd82026c3, 0x01400405, 0x1900001f, 0x10006814, 0xf0000000, 0xe1000003,
	0xa1d10407, 0x1b80001f, 0x20000020, 0xf0000000, 0x17c07c1f, 0xd8002a8a,
	0x17c07c1f, 0xe2e0004f, 0xe2e0006f, 0xe2e0002f, 0xd8202b2a, 0x17c07c1f,
	0xe2e0002e, 0xe2e0003e, 0xe2e00032, 0xf0000000, 0x17c07c1f, 0xd8002c2a,
	0x17c07c1f, 0xe2e00036, 0xe2e0003e, 0x1380201f, 0xe2e0003c, 0xd8202d4a,
	0x17c07c1f, 0x1380201f, 0xe2e0007c, 0x1b80001f, 0x20000003, 0xe2e0005c,
	0xe2e0004c, 0xe2e0004d, 0xf0000000, 0x17c07c1f, 0x18c0001f, 0x10006b6c,
	0x1910001f, 0x10006b6c, 0xa1002804, 0xe0c00004, 0xf0000000, 0x17c07c1f,
	0xd8202f89, 0x17c07c1f, 0xe2e0000d, 0xe2e0000c, 0xe2e0001c, 0xe2e0001e,
	0xe2e00016, 0xe2e00012, 0xf0000000, 0x17c07c1f, 0xd8203109, 0x17c07c1f,
	0xe2e00016, 0x1380201f, 0xe2e0001e, 0x1380201f, 0xe2e0001c, 0x1380201f,
	0xe2e0000c, 0xe2e0000d, 0xf0000000, 0x17c07c1f, 0x18d0001f, 0x10006604,
	0x10cf8c1f, 0xd8203143, 0x17c07c1f, 0xf0000000, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x1840001f, 0x00000001, 0xa1d48407, 0x1990001f,
	0x10006b08, 0x1a50001f, 0x10006610, 0x8246a401, 0xe8208000, 0x10006310,
	0x0b160008, 0xe8208000, 0x10006b6c, 0x00000000, 0x1b00001f, 0x2f7be35f,
	0x1b80001f, 0xd00f0000, 0x8880000c, 0x2f7be35f, 0xd8005c42, 0x17c07c1f,
	0xe8208000, 0x10006354, 0xfffe7b01, 0xc0c02940, 0x17c07c1f, 0x81401801,
	0xd8004b45, 0x17c07c1f, 0x81f60407, 0x1950001f, 0x10006b00, 0x81401401,
	0xd80043e5, 0x17c07c1f, 0x18c0001f, 0x10006200, 0xc0c029e0, 0x12807c1f,
	0xe8208000, 0x1000625c, 0x00000001, 0x1b80001f, 0x20000080, 0xc0c029e0,
	0x1280041f, 0x18c0001f, 0x10006204, 0xc0c02e80, 0x1280041f, 0x1950001f,
	0x10006b00, 0x81409401, 0xd8004665, 0x17c07c1f, 0x18c0001f, 0x10006208,
	0xc0c029e0, 0x12807c1f, 0xe8208000, 0x10006248, 0x00000000, 0x1b80001f,
	0x20000080, 0xc0c029e0, 0x1280041f, 0x1950001f, 0x10006b00, 0x81411401,
	0xd8004865, 0x17c07c1f, 0x18c0001f, 0x10006290, 0xc0c029e0, 0x1280041f,
	0xe8208000, 0x10006404, 0x00003101, 0x81449801, 0xd8004b45, 0x17c07c1f,
	0x1a00001f, 0x10006604, 0xe2200007, 0xc0c03140, 0x17c07c1f, 0xe2200003,
	0xc0c03140, 0x17c07c1f, 0x1950001f, 0x10006b00, 0x81419401, 0xd8004b45,
	0x17c07c1f, 0x81401801, 0xd8004ce5, 0x17c07c1f, 0xa1d38407, 0xa0108400,
	0xa0148400, 0xa01b8400, 0xa0188400, 0xe8208000, 0x10006310, 0x0b160008,
	0x81431801, 0xd8004ee5, 0x17c07c1f, 0xe8208000, 0x10006310, 0x0b1600c8,
	0x81439801, 0xd8204ee5, 0x17c07c1f, 0xe8208000, 0x10006310, 0x0b160038,
	0x12007c1f, 0x1b00001f, 0xbfffe7ff, 0x1950001f, 0x10006b00, 0x81421401,
	0xd8004f25, 0x17c07c1f, 0x1940001f, 0x001c0bae, 0x1950001f, 0x10006b00,
	0x814f9401, 0xd82050e5, 0x17c07c1f, 0x1b80001f, 0x00001000, 0x1b80001f,
	0x90100000, 0x1ac0001f, 0x10006b6c, 0xe2c00008, 0xe8208000, 0x10006310,
	0x0b160008, 0x82809c01, 0x1990001f, 0x10006b08, 0x81439801, 0xd8205325,
	0x17c07c1f, 0xca8017ea, 0x17c07c1f, 0xd0005360, 0x17c07c1f, 0xca80000a,
	0x17c07c1f, 0x1990001f, 0x10006b08, 0x81401801, 0xd8005705, 0x17c07c1f,
	0x81449801, 0xd80055a5, 0x17c07c1f, 0x1a00001f, 0x10006604, 0xe2200002,
	0xc0c03140, 0x17c07c1f, 0xe2200006, 0xc0c03140, 0x17c07c1f, 0x1b80001f,
	0x200016a8, 0x80388400, 0x1b80001f, 0x20000300, 0x803b8400, 0x1b80001f,
	0x20000300, 0x80348400, 0x1b80001f, 0x20000104, 0x80308400, 0x81f38407,
	0x81401801, 0xd8005c45, 0x17c07c1f, 0xe8208000, 0x10006404, 0x00002101,
	0x18c0001f, 0x10006290, 0x1212841f, 0xc0c02b60, 0x12807c1f, 0xc0c02b60,
	0x1280041f, 0x18c0001f, 0x10006208, 0x1212841f, 0xc0c02b60, 0x12807c1f,
	0xe8208000, 0x10006248, 0x00000001, 0x1b80001f, 0x20000080, 0xc0c02b60,
	0x1280041f, 0x18c0001f, 0x10006204, 0x1212841f, 0xc0c02fc0, 0x1280041f,
	0x18c0001f, 0x10006200, 0x1212841f, 0xc0c02b60, 0x12807c1f, 0xe8208000,
	0x1000625c, 0x00000000, 0x1b80001f, 0x20000080, 0xc0c02b60, 0x1280041f,
	0x19c0001f, 0x01411820, 0x10007c1f, 0xe8208000, 0x10006b30, 0x00000000,
	0xe8208000, 0x100063e0, 0x00000001, 0xf0000000, 0x17c07c1f
};

static struct pcm_desc sodi_pcm = {
	.version = "pcm_sodi_mt8173_v00.01_20141007",
	.base = sodi_binary,
	.size = 749,
	.sess = 2,
	.replace = 0,
	.vec2 = EVENT_VEC(30, 1, 0, 0),	/* FUNC_SUSPEND_APSRC_WAKEUP */
	.vec3 = EVENT_VEC(31, 1, 0, 79),	/* FUNC_SUSPEND_APSRC_SLEEP */
	.vec0 = EVENT_VEC(30, 1, 0, 191),	/* FUNC_APSRC_WAKEUP */
	.vec1 = EVENT_VEC(31, 1, 0, 221),	/* FUNC_APSRC_SLEEP */
};
#else
static const u32 sodi_binary[] = {
	0x81411801, 0xd8000165, 0x17c07c1f, 0x18c0001f, 0x10006240, 0xe0e00016,
	0xe0e0001e, 0xe0e0000e, 0xe0e0000f, 0xc2801320, 0x17c07c1f, 0x80368400,
	0x1b80001f, 0x20000208, 0x80370400, 0x1b80001f, 0x20000208, 0x80360400,
	0x803e0400, 0x1b80001f, 0x20000208, 0x80380400, 0x803b0400, 0xa01d8400,
	0x1b80001f, 0x20000034, 0x803d8400, 0x1b80001f, 0x20000152, 0x803d0400,
	0x1b80001f, 0x20000208, 0x18c0001f, 0x1000f5c8, 0x1910001f, 0x1000f5c8,
	0xa1000404, 0xe0c00004, 0x18c0001f, 0x100125c8, 0x1910001f, 0x100125c8,
	0xa1000404, 0xe0c00004, 0x1910001f, 0x100125c8, 0x80340400, 0x17c07c1f,
	0x17c07c1f, 0x80310400, 0x1b80001f, 0x2000000a, 0x18c0001f, 0x10006240,
	0xe0e0000d, 0xd8000725, 0x17c07c1f, 0x1b80001f, 0x20000100, 0x81fa0407,
	0x81f08407, 0x81f18407, 0xe8208000, 0x10006354, 0xfffe7b01, 0xa1d80407,
	0xa1dc0407, 0x8880000c, 0x2f7be35f, 0xd8200962, 0x17c07c1f, 0x1b00001f,
	0x3fffe7ff, 0xd00009a0, 0x17c07c1f, 0x1b00001f, 0xbfffe7ff, 0xf0000000,
	0x17c07c1f, 0x1b80001f, 0x20000fdf, 0x1890001f, 0x10006608, 0x80c98801,
	0x810a8801, 0x10918c1f, 0xa0939002, 0xa0950402, 0x8080080d, 0xd8200ca2,
	0x17c07c1f, 0x1b00001f, 0x3fffe7ff, 0x1b80001f, 0x20000004, 0xd80012ec,
	0x17c07c1f, 0x1b00001f, 0xbfffe7ff, 0xd00012e0, 0x17c07c1f, 0x81f80407,
	0x81fc0407, 0xe8208000, 0x10006354, 0xffffffff, 0x1b80001f, 0x20000020,
	0x02000408, 0x1880001f, 0x10006320, 0xc0c021a0, 0xe080000f, 0xd8000c23,
	0x17c07c1f, 0xe080001f, 0xa1da0407, 0xa0110400, 0xa0140400, 0x18c0001f,
	0x1000f5c8, 0x1910001f, 0x1000f5c8, 0x81200404, 0xe0c00004, 0x18c0001f,
	0x100125c8, 0x1910001f, 0x100125c8, 0x81200404, 0xe0c00004, 0x1910001f,
	0x100125c8, 0xa01d0400, 0xa01b0400, 0xa0180400, 0xa01e0400, 0xa0160400,
	0xa0170400, 0xa0168400, 0x1b80001f, 0x20000104, 0x81411801, 0xd80012a5,
	0x17c07c1f, 0x18c0001f, 0x10006240, 0xc0c020e0, 0x17c07c1f, 0x1b00001f,
	0x7fffe7ff, 0xf0000000, 0x17c07c1f, 0x18c0001f, 0x100110e4, 0x1910001f,
	0x100110e4, 0xa1158404, 0xe0c00004, 0x81358404, 0xe0c00004, 0x18c0001f,
	0x100040e4, 0x1910001f, 0x100040e4, 0xa1158404, 0xe0c00004, 0x81358404,
	0xe0c00004, 0xf0000000, 0x17c07c1f, 0x803d8400, 0x1b80001f, 0x2000001a,
	0x80340400, 0x17c07c1f, 0x17c07c1f, 0x80310400, 0x89c00007, 0xffeffff5,
	0xa9c00007, 0x01010000, 0x1b80001f, 0x200000d0, 0x1b00001f, 0xbfffe7ff,
	0x1b00001f, 0xffffffff, 0x1b80001f, 0x20000004, 0x8a80000c, 0x2f7be35f,
	0xd820188a, 0x17c07c1f, 0x1b00001f, 0x3fffe7ff, 0xf0000000, 0x17c07c1f,
	0x1a90001f, 0x10212018, 0x828fa801, 0xa281b40a, 0xa285340a, 0x82802801,
	0xd800170a, 0x17c07c1f, 0x1b00001f, 0xffffffff, 0x1b80001f, 0x20000004,
	0x8a80000c, 0x2f7be35f, 0xd800184a, 0x17c07c1f, 0x1b80001f, 0x20000020,
	0x02000408, 0x89c00007, 0xfefeffff, 0xa9c00007, 0x0010000a, 0x1b80001f,
	0x20000020, 0x810ab401, 0x80cbb401, 0x80c00c04, 0xd8001fa3, 0x17c07c1f,
	0x89c00007, 0xfffffff5, 0xa9c00007, 0x0000000a, 0x1b80001f, 0x20000020,
	0x810ab401, 0x80cbb401, 0x80c00c04, 0xd8001fa3, 0x17c07c1f, 0x89c00007,
	0xffeffff5, 0xa9c00007, 0x01010000, 0x1880001f, 0x10006814, 0xe0800001,
	0x1880001f, 0x10006320, 0xe080000f, 0x1b00001f, 0x2f7be35f, 0xd00020a0,
	0x17c07c1f, 0xa0110400, 0xa0140400, 0x814f9801, 0xd8002065, 0x17c07c1f,
	0xa01d8400, 0x1b00001f, 0x7fffe7ff, 0xf0000000, 0x17c07c1f, 0xe0f07f0d,
	0xe0f07f0f, 0xe0f07f1e, 0xe0f07f12, 0xf0000000, 0x17c07c1f, 0x11407c1f,
	0x81f08407, 0x81f18407, 0x1b80001f, 0x20000001, 0xa1d08407, 0xa1d18407,
	0x1b80001f, 0x20000020, 0x812ab401, 0x80ebb401, 0xa0c00c04, 0xd82023c3,
	0x17c07c1f, 0x80c01403, 0xd82021c3, 0x01400405, 0x1900001f, 0x10006814,
	0xf0000000, 0xe1000003, 0xa1d10407, 0x1b80001f, 0x20000020, 0xf0000000,
	0x17c07c1f, 0xd800258a, 0x17c07c1f, 0xe2e0004f, 0xe2e0006f, 0xe2e0002f,
	0xd820262a, 0x17c07c1f, 0xe2e0002e, 0xe2e0003e, 0xe2e00032, 0xf0000000,
	0x17c07c1f, 0xd800272a, 0x17c07c1f, 0xe2e00036, 0xe2e0003e, 0x1380201f,
	0xe2e0003c, 0xd820284a, 0x17c07c1f, 0x1380201f, 0xe2e0007c, 0x1b80001f,
	0x20000003, 0xe2e0005c, 0xe2e0004c, 0xe2e0004d, 0xf0000000, 0x17c07c1f,
	0x18c0001f, 0x10006b6c, 0x1910001f, 0x10006b6c, 0xa1002804, 0xe0c00004,
	0xf0000000, 0x17c07c1f, 0xd8202a89, 0x17c07c1f, 0xe2e0000d, 0xe2e0000c,
	0xe2e0001c, 0xe2e0001e, 0xe2e00016, 0xe2e00012, 0xf0000000, 0x17c07c1f,
	0xd8202c09, 0x17c07c1f, 0xe2e00016, 0x1380201f, 0xe2e0001e, 0x1380201f,
	0xe2e0001c, 0x1380201f, 0xe2e0000c, 0xe2e0000d, 0xf0000000, 0x17c07c1f,
	0x18d0001f, 0x10006604, 0x10cf8c1f, 0xd8202c43, 0x17c07c1f, 0xf0000000,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f, 0x17c07c1f,
	0x17c07c1f, 0x17c07c1f, 0x1840001f, 0x00000001, 0xa1d48407, 0x1990001f,
	0x10006b08, 0x1a50001f, 0x10006610, 0x8246a401, 0xe8208000, 0x10006310,
	0x0b160008, 0xe8208000, 0x10006b6c, 0x00000000, 0x1b00001f, 0x2f7be35f,
	0x81469801, 0xd8004365, 0x17c07c1f, 0x1b80001f, 0xd00f0000, 0x8880000c,
	0x2f7be35f, 0xd8005ac2, 0x17c07c1f, 0xd00043a0, 0x17c07c1f, 0x1b80001f,
	0x500f0000, 0x1950001f, 0x10006b0c, 0x81400405, 0xd80044e5, 0x17c07c1f,
	0xe8208000, 0x10006354, 0xfffe7b01, 0xd0004540, 0x17c07c1f, 0xe8208000,
	0x10006354, 0xe3000000, 0xc0c02440, 0x17c07c1f, 0x81401801, 0xd8004c85,
	0x17c07c1f, 0x81f60407, 0x18c0001f, 0x10006200, 0xc0c024e0, 0x12807c1f,
	0xe8208000, 0x1000625c, 0x00000001, 0x1b80001f, 0x20000080, 0xc0c024e0,
	0x1280041f, 0x18c0001f, 0x10006204, 0xc0c02980, 0x1280041f, 0x18c0001f,
	0x10006208, 0xc0c024e0, 0x12807c1f, 0xe8208000, 0x10006248, 0x00000000,
	0x1b80001f, 0x20000080, 0xc0c024e0, 0x1280041f, 0x18c0001f, 0x10006290,
	0xc0c024e0, 0x1280041f, 0xe8208000, 0x10006404, 0x00003101, 0x81469801,
	0xd8204b85, 0x17c07c1f, 0x1b00001f, 0x2f7be35f, 0x1b80001f, 0x30000004,
	0x8880000c, 0x2f7be35f, 0xd8005582, 0x17c07c1f, 0x81449801, 0xd8004c85,
	0x17c07c1f, 0x1a00001f, 0x10006604, 0xe2200003, 0xc0c02c40, 0x17c07c1f,
	0x81401801, 0xd8004d85, 0x17c07c1f, 0xa1d38407, 0xa0108400, 0xa0148400,
	0xa01b8400, 0xa0188400, 0xe8208000, 0x10006310, 0x0b160008, 0x81431801,
	0xd8004f85, 0x17c07c1f, 0xe8208000, 0x10006310, 0x0b1600c8, 0x81439801,
	0xd8204f85, 0x17c07c1f, 0xe8208000, 0x10006310, 0x0b160038, 0x12007c1f,
	0x1b00001f, 0xbfffe7ff, 0x1b80001f, 0x90100000, 0x1ac0001f, 0x10006b6c,
	0xe2c00008, 0xe8208000, 0x10006310, 0x0b160008, 0x82809c01, 0x1990001f,
	0x10006b08, 0x81439801, 0xd8205205, 0x17c07c1f, 0xca80156a, 0x17c07c1f,
	0xd0005240, 0x17c07c1f, 0xca80000a, 0x17c07c1f, 0x1990001f, 0x10006b08,
	0x81401801, 0xd8005585, 0x17c07c1f, 0x81449801, 0xd8005425, 0x17c07c1f,
	0x1a00001f, 0x10006604, 0xe2200002, 0xc0c02c40, 0x17c07c1f, 0x1b80001f,
	0x200016a8, 0x80388400, 0x1b80001f, 0x20000300, 0x803b8400, 0x1b80001f,
	0x20000300, 0x80348400, 0x1b80001f, 0x20000104, 0x80308400, 0x81f38407,
	0x81401801, 0xd8005ac5, 0x17c07c1f, 0xe8208000, 0x10006404, 0x00002101,
	0x18c0001f, 0x10006290, 0x1212841f, 0xc0c02660, 0x12807c1f, 0xc0c02660,
	0x1280041f, 0x18c0001f, 0x10006208, 0x1212841f, 0xc0c02660, 0x12807c1f,
	0xe8208000, 0x10006248, 0x00000001, 0x1b80001f, 0x20000080, 0xc0c02660,
	0x1280041f, 0x18c0001f, 0x10006204, 0x1212841f, 0xc0c02ac0, 0x1280041f,
	0x18c0001f, 0x10006200, 0x1212841f, 0xc0c02660, 0x12807c1f, 0xe8208000,
	0x1000625c, 0x00000000, 0x1b80001f, 0x20000080, 0xc0c02660, 0x1280041f,
	0xe8208000, 0x10006354, 0x00000000, 0x19c0001f, 0x01411820, 0x10007c1f,
	0xe8208000, 0x10006b30, 0x00000000, 0xe8208000, 0x100063e0, 0x00000001,
	0xf0000000, 0x17c07c1f
};

static struct pcm_desc sodi_pcm = {
	.version = "pcm_sodi_e2_mt8173_v00.02_20160113_v1",
	.base = sodi_binary,
	.size = 740,
	.sess = 2,
	.replace = 0,
	.vec2 = EVENT_VEC(30, 1, 0, 0),	/* FUNC_SUSPEND_APSRC_WAKEUP */
	.vec3 = EVENT_VEC(31, 1, 0, 79),	/* FUNC_SUSPEND_APSRC_SLEEP */
	.vec0 = EVENT_VEC(30, 1, 0, 171),	/* FUNC_APSRC_WAKEUP */
	.vec1 = EVENT_VEC(31, 1, 0, 198),	/* FUNC_APSRC_SLEEP */
};
#endif

static struct pwr_ctrl sodi_ctrl = {
	.wake_src = WAKE_SRC_FOR_SODI,
	.wake_src_md32 = WAKE_SRC_FOR_MD32,
	.r0_ctrl_en = 1,
	.r7_ctrl_en = 1,
	.wfi_op = WFI_OP_AND,
	.param1 = 1,	/* idle type: SODI */
#if (!SODI_DVT_APxGPT)
	.ca15_wfi0_en = 1,
	.ca15_wfi1_en = 1,
	.ca7_wfi0_en = 1,
	.ca7_wfi1_en = 1,
	.ca7_wfi2_en = 1,
	.ca7_wfi3_en = 1,
	.mfg_req_mask = 1,
#if SPM_BYPASS_SYSPWREQ
	.syspwreq_mask = 1,
#endif
#else
	.ca15_wfi0_en = 0,
	.ca15_wfi1_en = 0,
	.ca7_wfi0_en = 1,
	.ca7_wfi1_en = 0,
	.ca7_wfi2_en = 0,
	.ca7_wfi3_en = 0,
	.disp_req_mask = 1,
	.mfg_req_mask = 1,
	.md32_req_mask = 1,
	.mcusys_idle_mask = 1,
	.ca7top_idle_mask = 1,
	.ca15top_idle_mask = 1,
#if SPM_BYPASS_SYSPWREQ
	.syspwreq_mask = 1,
#endif
#endif
};

struct spm_lp_scen __spm_sodi = {
	.pcmdesc = &sodi_pcm,
	.pwrctrl = &sodi_ctrl,
};

static bool gSpm_SODI_mempll_pwr_mode = 1;
static bool gSpm_sodi_en;

void __attribute__ ((weak)) soidle_before_wfi(int cpu)
{
}

void __attribute__ ((weak)) soidle_after_wfi(int cpu)
{
}

static void spm_trigger_wfi_for_sodi(struct pwr_ctrl *pwrctrl)
{
#if 0
	sync_hw_gating_value();	/* for Vcore DVFS */
#endif

	if (is_cpu_pdn(pwrctrl->pcm_flags)) {
		mt_cpu_dormant(CPU_SODI_MODE);
	} else {

		spm_write(MCUSYS_CONFIG, spm_read(MCUSYS_CONFIG) | 0x10);
		wfi_with_sync();
		spm_write(MCUSYS_CONFIG, spm_read(MCUSYS_CONFIG) & ~0x10);

	}
}

#if SODI_DVT_SPM_MEM_RW_TEST
static u32 magic_init;
#endif

void spm_go_to_sodi(u32 spm_flags, u32 spm_data)
{
	struct wake_status wakesta;
	unsigned long flags;
	struct mtk_irq_mask mask;
	wake_reason_t wr = WR_NONE;
	struct pcm_desc *pcmdesc = __spm_sodi.pcmdesc;
	struct pwr_ctrl *pwrctrl = __spm_sodi.pwrctrl;

#if SODI_DVT_SPM_MEM_RW_TEST
	if (magic_init == 0) {
		magic_init++;
		pr_debug("[SODI] magicNumArray:0x%x", magicArray);
	}
#endif

	set_pwrctrl_pcm_flags(pwrctrl, spm_flags);

	/* set PMIC WRAP table for SODI power control */
	mt_cpufreq_set_pmic_phase(PMIC_WRAP_PHASE_SODI);

	lockdep_off();
	spin_lock_irqsave(&__spm_lock, flags);
	mt_irq_mask_all(&mask);
	mt_irq_unmask_for_sleep(SPM_IRQ0_ID);
	mt_cirq_clone_gic();
	mt_cirq_enable();

	__spm_reset_and_init_pcm(pcmdesc);
#if 0				/* workaroud for ca17 disp mempll power down switch crash */
	if (gSpm_SODI_mempll_pwr_mode == 1) {
		/* MEMPLL reset mode */
		pwrctrl->pcm_flags |= SPM_MEMPLL_RESET;
	} else
		pwrctrl->pcm_flags &= ~SPM_MEMPLL_RESET;
#else
	pwrctrl->pcm_flags |= SPM_MEMPLL_RESET | SPM_SCREEN_OFF;
#endif

	__spm_kick_im_to_fetch(pcmdesc);

	__spm_init_pcm_register();

	__spm_init_event_vector(pcmdesc);

	__spm_set_power_control(pwrctrl);

	__spm_set_wakeup_event(pwrctrl);

#if SODI_DVT_BLOCK_BF_WFI && SODI_DVT_APxGPT
	spm_write(SPM_PCM_CON1, spm_read(SPM_PCM_CON1) & (~CON1_PCM_TIMER_EN));
	pwrctrl->pcm_reserve = 0x000003ff;
#endif

	__spm_kick_pcm_to_run(pwrctrl);

	soidle_before_wfi(0);

	spm_trigger_wfi_for_sodi(pwrctrl);

	soidle_after_wfi(0);

	__spm_get_wakeup_status(&wakesta);

	__spm_clean_after_wakeup();

	wr = __spm_output_wake_reason(&wakesta, pcmdesc, false);

	mt_cirq_flush();
	mt_cirq_disable();
	mt_irq_mask_restore(&mask);
	spin_unlock_irqrestore(&__spm_lock, flags);
	lockdep_on();

	/* set PMIC WRAP table for normal power control */
	mt_cpufreq_set_pmic_phase(PMIC_WRAP_PHASE_NORMAL);

#if SODI_DVT_SPM_MEM_RW_TEST
	int i = 0;

	for (i = 0; i < 16; i++) {
		if (magicArray[i] != SODI_DVT_MAGIC_NUM) {
			pr_debug("[SODI] Error: sodi magic number no match!!!");
			ASSERT(0);
		}
	}
#endif

	/* return wr; */
}

void spm_sodi_mempll_pwr_mode(bool pwr_mode)
{
	gSpm_SODI_mempll_pwr_mode = pwr_mode;
}

void spm_enable_sodi(bool en)
{
	gSpm_sodi_en = en;
}

bool spm_get_sodi_en(void)
{
	return gSpm_sodi_en;
}

#if 0
static void spm_set_sodi_pcm_ver(void)
{
	CHIP_SW_VER ver = mt_get_chip_sw_ver();

	if (CHIP_SW_VER_02 <= ver) {
		/*E2 SODI FW */
		__spm_sodi.pcmdesc = &sodi_pcm_e2;
	}
}
#endif

void spm_sodi_init(void)
{
	/* spm_set_sodi_pcm_ver(); */
#ifdef CONFIG_OF
	struct device_node *mcucfg_node;

	mcucfg_node = of_find_compatible_node(NULL, NULL, "mediatek,mt8173-mcucfg");
	if (!mcucfg_node) {
		pr_err("mcucfg_node not found!\n");
		return;
	}

	mcucfg_base = of_iomap(mcucfg_node, 0);
	pr_info("mcucfg_base: 0x%08lx\n", (unsigned long)mcucfg_base);
	if (!mcucfg_base) {
		pr_err("mcucfg_base map failed!\n");
		return;
	}
#endif
}

#if 0
void spm_sodi_lcm_video_mode(bool IsLcmVideoMode)
{
	gSpm_IsLcmVideoMode = IsLcmVideoMode;

	spm_idle_ver("spm_sodi_lcm_video_mode() : gSpm_IsLcmVideoMode = %x\n", gSpm_IsLcmVideoMode);

}
#endif
MODULE_DESCRIPTION("SPM-SODI Driver v0.1");
